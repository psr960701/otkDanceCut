# 随舞音频拼接工具

这是一个功能强大的音频拼接工具，支持交互式操作，适用于舞蹈练习、活动准备等场景。

## 功能特点

- 🎵 **音频拼接**：将随舞目录下的音频文件无缝拼接
- ⏰ **倒计时过渡**：使用倒计时.mp3作为音频之间的过渡
- 🎲 **两种模式**：支持随机拼接和顺序拼接
- 🖥️ **图形界面**：基于PyQt5的友好图形用户界面
- 📊 **详细信息**：输出拼接后的歌曲顺序和总时长
- ⚡ **并发处理**：支持并发加载音频文件，提高处理效率，动态线程池调整（基于CPU核心数）
- 📁 **曲库管理**：支持管理曲库目录中的音频文件
- 💾 **智能缓存**：使用LRU缓存和时长缓存优化性能，30天自动过期机制
- 📝 **日志管理**：使用loguru库进行结构化日志管理，替代print语句
- 🎨 **UI优化**：改进UI组件封装设计，使用私有属性和属性访问器，提高代码可维护性
- 📦 **打包优化**：优化PyInstaller打包配置（optimize=1, upx=False），平衡性能与兼容性
- 🔧 **权限管理**：ffmpeg-path.bat脚本添加管理员权限检查和明确提示
- 📋 **常量管理**：集中管理配置常量，消除硬编码值

## 目录结构

```
├── 随舞/               # 存放待拼接的音频文件（外部目录，需手动放置）
├── 曲库/               # 曲库目录（外部目录，需手动放置）
├── 倒计时.mp3          # 倒计时过渡音频
├── src/                # 核心代码目录
│   ├── main.py         # 程序主入口
│   ├── utils/          # 工具类
│   │   ├── utils.py    # 通用工具函数
│   │   ├── cache_utils.py  # 缓存管理工具
│   │   ├── fix_encoding.py  # 编码修复工具
│   │   └── update_cache.py  # 缓存更新工具
│   ├── constants.py    # 常量配置文件
│   ├── threads/        # 线程相关
│   │   └── worker_threads.py # 后台工作线程
│   ├── core/           # 核心功能
│   │   ├── audio_processor.py # 音频处理核心
│   │   └── audio_splicer.py # 音频拼接核心
│   └── ui/             # 用户界面
│       └── ui_components.py # UI组件
├── 音乐剪辑器.spec     # PyInstaller打包配置
├── requirements.txt    # 项目依赖
└── README.md           # 项目说明
```

## 安装依赖

首先确保你的环境中已经安装了Python 3.6或更高版本。

```bash
# 安装所需依赖
pip install -r requirements.txt
```

### requirements.txt中文注释问题

在Windows系统中，当requirements.txt文件包含中文注释时，使用`pip install -r requirements.txt`可能会遇到编码错误。

解决方案：
1. **使用GBK编码**：在Windows系统中，pip默认使用GBK编码读取requirements.txt文件
2. **手动修复**：使用文本编辑器（如Notepad++）将文件编码转换为GBK

## 使用方法

### 图形界面模式

运行图形界面音频拼接工具：

```bash
python src/main.py
```

工具界面包含以下功能：

1. **添加文件**：手动添加音频文件到拼接列表
2. **随机/顺序拼接**：选择拼接模式
3. **自动加载**：自动加载随舞目录下的音频文件
4. **选择倒计时**：选择自定义倒计时音频
5. **拼接音频**：开始拼接并保存输出文件

## 打包配置

项目使用PyInstaller进行打包，配置文件为`音乐剪辑器.spec`。

### 打包命令

```bash
pyinstaller 音乐剪辑器.spec
```

### 打包配置说明

当前打包配置仅包含必要的文件，不包含随舞和曲库目录：

```python
datas=[('倒计时.mp3', '.'), ('src/', 'src')],
```

### 程序运行注意事项

1. 打包后的程序运行时，会自动在当前目录查找`随舞`和`曲库`目录
2. 请确保这些目录与程序可执行文件在同一目录下
3. 程序会自动加载当前目录下的`倒计时.mp3`文件

## 核心功能详解

### 音频拼接
- **支持格式**: MP3、WAV、OGG、FLAC、AAC、M4A、WMA
- **拼接模式**: 随机拼接和顺序拼接
- **过渡效果**: 使用倒计时.mp3文件作为音频之间的过渡
- **淡入淡出**: 开头和结尾各2秒的渐变效果

### 图形界面
- **功能**: 可视化操作，支持拖拽文件，实时进度显示
- **特点**: 使用QThread避免UI冻结，支持批量处理

### 缓存机制
- **LRU缓存**: 限制最大100个文件，优化内存使用
- **时长缓存**: 存储音频文件的时长信息，避免重复计算
- **缓存键优化**: 使用文件名作为缓存键，避免路径变化导致的重复缓存
- **缓存格式**: JSON格式存储，包含时长和缓存时间戳
- **缓存过期**: 30天自动过期机制，确保缓存数据新鲜

### 并发处理
- **动态线程池**: 根据系统CPU核心数动态调整线程池大小（max_workers = min(cpu_count + 1, 12)）
- **任务类型区分**: 支持高负载/低负载任务类型，动态调整并发数
- **并行参数优化**: 支持动态调整并行合并的num_workers和min_segments参数

### 日志管理
- **结构化日志**: 使用loguru库代替print语句，提供更高效的日志管理
- **多级别日志**: 支持debug、info、error等不同级别的日志
- **日志文件**: 自动生成日志文件，便于问题排查

### 代码优化
- **常量管理**: 集中管理所有配置常量，减少硬编码
- **UI封装**: 改进UI组件封装设计，提高代码可维护性
- **错误处理**: 增强错误捕获和处理机制，提高程序稳定性
- **状态更新**: 减少UI状态更新频率，提高界面响应性能

```python
# 缓存结构示例
{
    "audio_file.mp3": {
        "duration": 120.5,
        "cache_time": 1630000000.0
    }
}
```

### 并发处理
- **功能**: 支持并发加载音频文件和获取时长信息
- **特点**: 可在界面中切换并发功能的启用状态，根据系统CPU核心数动态调整线程池大小（max_workers = min(cpu_count + 1, 12)）
- **任务区分**: 支持高负载/低负载任务类型，动态调整并发数
- **并行参数优化**: 支持动态调整并行合并的num_workers和min_segments参数
- **状态更新优化**: 减少UI状态更新频率，提高界面响应性能（每10个文件更新一次状态）

## 核心代码组件

### 1. main.py

程序主入口，负责初始化界面、加载资源和处理用户交互。

### 2. audio_processor.py

音频处理核心，包含音频加载、拼接、时长计算等功能。

### 3. audio_splicer.py

音频拼接核心，实现音频文件的拼接逻辑。

### 4. cache_utils.py

缓存管理工具，实现LRU缓存和时长缓存功能，优化程序性能。

### 5. fix_encoding.py

编码修复工具，解决文件编码问题。

### 6. update_cache.py

缓存更新工具，管理音频时长缓存的更新和维护。

### 7. worker_threads.py

后台工作线程，用于异步加载音频文件和处理耗时操作，避免阻塞UI。

### 8. ui_components.py

UI组件定义，负责构建和管理程序的图形界面，使用私有属性和属性访问器提高封装性。

### 9. constants.py

常量配置文件，集中管理所有配置参数，包括文件名、目录名等，消除硬编码值。

## 测试方法

1. **功能测试**：
   - 将音频文件放入`随舞`目录
   - 运行程序，选择拼接模式
   - 检查输出文件是否正常生成

2. **性能测试**：
   - 放入大量音频文件测试并发加载功能
   - 检查缓存机制是否有效减少重复计算

3. **边界测试**：
   - 测试不同格式的音频文件
   - 测试空目录或不存在的目录情况
   - 测试不同时长的音频文件拼接

## ffmpeg配置

由于ffmpeg.exe和ffprobe.exe文件较大（超过100MB），无法直接推送到GitHub仓库，您需要手动添加ffmpeg工具：

### 手动添加ffmpeg方法

1. **下载ffmpeg**：
   - 访问[ffmpeg官方网站](https://ffmpeg.org/download.html)
   - 选择适合您操作系统的版本下载（建议下载静态版本）
   
2. **安装配置**：
   - 解压下载的压缩包
   - 将解压后得到的`ffmpeg.exe`和`ffprobe.exe`文件复制到项目根目录下的`ffmpeg`文件夹中
   - 确保目录结构为：`项目根目录/ffmpeg/ffmpeg.exe`和`项目根目录/ffmpeg/ffprobe.exe`

### 将ffmpeg推送到git的免费方法

如果您希望将ffmpeg文件包含在git仓库中，可以使用以下方法：

1. **使用Git LFS（Large File Storage）**：
   ```bash
   # 安装Git LFS
   git lfs install
   
   # 跟踪大文件
   git lfs track "ffmpeg/ffmpeg.exe"
   git lfs track "ffmpeg/ffprobe.exe"
   
   # 提交并推送
   git add .gitattributes ffmpeg/ffmpeg.exe ffmpeg/ffprobe.exe
   git commit -m "Add ffmpeg binaries"
   git push origin master
   ```

2. **提供下载链接**：
   - 在README中提供ffmpeg的下载链接
   - 编写自动下载脚本，在程序首次运行时自动下载ffmpeg

## 注意事项

1. 确保`随舞`和`曲库`目录存在于程序运行目录
2. 确保`倒计时.mp3`文件存在于程序运行目录
3. 确保ffmpeg已正确配置（参考上面的ffmpeg配置部分）
4. 支持的音频格式：MP3、WAV、OGG、FLAC、AAC、M4A、WMA
5. 拼接后的音频默认保存为MP3格式
6. 程序会自动计算音频时长并缓存，首次运行可能需要较长时间

## 更新日志

- **v0.1.5**：核心优化版本
  - 实现30天缓存自动过期机制
  - 优化并行合并参数（动态num_workers和min_segments）
  - 实现基于CPU核心数的动态并发控制
  - 使用loguru库替代print语句进行日志管理
  - 减少UI状态更新频率，提高响应性能
  - 完善音频拼接错误处理机制
  - 改进UI组件封装设计（私有属性+属性访问器）
  - 集中管理常量配置，消除硬编码值
  - ffmpeg-path.bat添加管理员权限检查和提示
  - 优化PyInstaller打包配置（optimize=1, upx=False）

- **v0.1.4**：添加曲库管理功能，支持后台加载
- **v0.1.3**：优化打包配置，减小程序体积
- **v0.1.2**：优化缓存机制，使用文件名作为缓存键
- **v0.1.1**：添加图形界面，支持并发处理
- **v0.1.0**：初始版本，支持基本的音频拼接功能

## 许可证

MIT License
